<html>
<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <link rel="stylesheet" href="watchboard.css" type="text/css">
    <script type="text/javascript" src="watchboard.js"></script>
</head>
<body>

<script type="text/javascript">
    var appVersion;
    var lastAppRefresh = new Date().getTime();
    var lastUpdated = 0;

    $(document).ready(function () {
        var pathname = window.location.pathname;
        if (endsWith(pathname, '/')) {
            pathname = pathname.substring(0, pathname.length - 1);
        }
        var dashboardId = pathname.substring(pathname.lastIndexOf('/') + 1, pathname.length);

        // Read number of columns from URL parameter.
        var numberOfColumns = getUrlVars()["columns"];
        if (numberOfColumns == undefined) {
            numberOfColumns = 2;
        }

        // Render column selection.
        maxNumberOfColumns = 4;
        var columnSelectionHTML = "Columns: ";
        for (col = 1; col <= maxNumberOfColumns; col++) {
            // Add switch link.
            if (col != numberOfColumns) {
                columnSelectionHTML += "<a href=\"?columns=" + col + "\">" + col + "</a>";
            } else {
                columnSelectionHTML += col;
            }

            if (col != maxNumberOfColumns) {
                columnSelectionHTML += " | ";
            }
        }
        $("#columnSelection").html(columnSelectionHTML);
        var imageWidthPercentage = (100 / numberOfColumns) - 1;

        // Initial rendering.
        $.ajax({
            url: '../api/v1/status/' + dashboardId,
            success: function (data) {
                appVersion = data.appVersion;
                $("#title").text(data.title);
                for (var i = 0; i < data.images.length; i++) {
                    image = data.images[i];
                    $("#images").html($("#images").html() +
                            "<a href=\"" + image.url + "\" target=\"_blank\">" +
                            "<img style=\"margin: 4px\" id=\"" + image.id + "\" " +
                            "data-lastmodified=\"" + image.lastModified + "\" " +
                            "width=\"" + imageWidthPercentage + "%\" " +
                            "src=\"" + image.filename + "\"></a>");
                }
            }
        });

        // Periodic update.
        setInterval(function () {
            $.ajax({
                url: '../api/v1/status/' + dashboardId,
                success: function (data) {
                    // New backend version and last refresh was over 30 seconds ago (to throttle refreshes).
                    if ((appVersion != data.appVersion) && (new Date().getTime() - lastAppRefresh > 30000)) {
                        // Force reload of page from server to keep front- and backend in sync.
                        location.reload(true);
                        lastAppRefresh = new Date().getMilliseconds();
                    }

                    for (var i = 0; i < data.images.length; i++) {
                        image = data.images[i];
                        imageElement = $('img#' + image.id)
                        storedLastModified = imageElement.attr("data-lastmodified");
                        newLastModified = image.lastModified;
                        if (newLastModified != storedLastModified) {
                            // refresh.
                            imageElement.attr('data-lastmodified', image.lastModified);
                            imageElement.attr('src', image.filename + '?' + image.lastModified);
                        }
                        if (newLastModified > lastUpdated) {
                            lastUpdated = newLastModified;
                            $("#lastUpdated").text(new Date(lastUpdated));

                        }

                    }
                }
            });
            // Scan each second for updated images.
        }, 1000);

    });
</script>
<div id="topBar">
    <span id="back">
        <a href=".."><img src="back-icon.png" id="backIcon"></a>
    </span>
        <span id="logo" class="logo-bordered">
            <a href="https://github.com/bertjan/watchboard">
            Watchboard
            </a>
        </span>
    <span id="columnSelection"></span>
    <span>
        <span id="title"></span>
    </span>
    <div id="lastUpdatedWrapper">
        Last updated: <span id="lastUpdated">(never)</span>
    </div>
</div>

<div id="images"></div>

</body>
</html>