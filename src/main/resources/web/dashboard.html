<html>
<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body style="margin: 2px; padding: 0px;">

<script type="text/javascript">
    var appVersion;
    var lastAppRefresh = new Date().getTime();

    function endsWith(str, suffix) {
        return str.indexOf(suffix, str.length - suffix.length) !== -1;
    }

    function getUrlVars() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }


    $(document).ready(function() {
        var pathname = window.location.pathname;
        if (endsWith(pathname, '/')) {
            pathname = pathname.substring(0, pathname.length-1);
        }
        var dashboardId = pathname.substring(pathname.lastIndexOf('/')+1, pathname.length);

        // Read number of columns from URL parameter.
        var numberOfColumns = getUrlVars()["columns"];
        if (numberOfColumns == undefined) {
            numberOfColumns = 2;
        }

        // Render column selection.
        maxNumberOfColumns = 4;
        var columSelectionHTML = "Columns: ";
        for (col = 1; col <= maxNumberOfColumns; col++) {
            // Add switch link.
            if (col != numberOfColumns) {
                columSelectionHTML += "<a href=\"?columns=" + col + "\">" + col + "</a>";
            } else {
                columSelectionHTML += col;
            }

            if (col != maxNumberOfColumns) {
                columSelectionHTML += " | ";
            }
        }
        $("#columSelection").html(columSelectionHTML);
        var imageWidthPercentage = (100 / numberOfColumns) - 1;

        // Initial rendering.
        $.ajax({
            url: '../api/v1/status/' + dashboardId,
            success:function(data) {
                appVersion = data.appVersion;
                $("#title").text(data.title); // TODO: add last update time
                for (var i = 0; i < data.images.length; i++) {
                    image = data.images[i];
                    $("#images").html($("#images").html() +
                            "<a href=\""+ image.url + "\" target=\"_blank\">" +
                            "<img style=\"margin: 4px\" id=\""  + image.id + "\" " +
                            "data-lastmodified=\""+ image.lastModified +"\" " +
                            "width=\"" + imageWidthPercentage + "%\" " +
//                            "height=\"" + image.height + "\" " +
                            "src=\"" + image.filename + "\"></a>");
                }
            }
        });

        // Periodic update.
        setInterval(function(){
            $.ajax({
                url: '../api/v1/status/' + dashboardId,
                success:function(data){
                    // New backend version and last refresh was over 30 seconds ago (to throttle refreshes).
                    if ((appVersion != data.appVersion) && (new Date().getTime() - lastAppRefresh > 30000)) {
                        // Force reload of page from server to keep front- and backend in sync.
                        location.reload(true);
                        lastAppRefresh = new Date().getMilliseconds();
                    }

                    for (var i = 0; i < data.images.length; i++) {
                        image = data.images[i];
                        imageElement=$('img#'+image.id)
                        storedLastModified=imageElement.attr("data-lastmodified");
                        newLastModified=image.lastModified;

                        if (newLastModified != storedLastModified) {
                            // refresh.
                            imageElement.attr('data-lastmodified', image.lastModified);
                            imageElement.attr('src', image.filename + '?' + image.lastModified);
                        }
                    }
                }
            });
            // Scan each second for updated images.
        }, 1000);

    });
</script>
<a href=".."><img src="back-icon.png" style="height: 50px; position: absolute; top:-13px; left: -10px;"></a>
<div style="position: absolute; top:5px; left: 35px; font-size: 14px">
    <span id="columSelection"></span>
</div>
<div style="text-align:center"><span id="title" style="font-weight:bold"></span></div>
<div id="images"></div>

</body>
</html>