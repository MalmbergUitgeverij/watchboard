<html>
<head>
    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <link rel="stylesheet" href="watchboard.css" type="text/css">
    <script type="text/javascript" src="watchboard.js"></script>
</head>
<body>

<script type="text/javascript">
    var appVersion;
    var configLastUpdated;
    var lastAppRefresh = new Date().getTime();
    var lastUpdated = 0;
    var numberOfColumns;

    function setURLHash() {
        var imageOrder = $('#images').children('li').map(function(){
            return $(this).find("img").attr('id')
        }).get();
        location.hash = 'columns=' + numberOfColumns + "|" + "imageOrder=" + imageOrder;
    }


    function setColumns(numCols) {
        numberOfColumns = numCols;
        setURLHash();
        refreshPage();
    }

    function refreshPage() {
        location.reload(true);
        lastAppRefresh = new Date().getMilliseconds();
    }


    $(document).ready(function () {
        var pathname = window.location.pathname;
        if (endsWith(pathname, '/')) {
            pathname = pathname.substring(0, pathname.length - 1);
        }
        var dashboardId = pathname.substring(pathname.lastIndexOf('/') + 1, pathname.length);

        // Read number of columns from URL parameter.
        numberOfColumns = getHashParam()["columns"];
        if (numberOfColumns == undefined) {
            numberOfColumns = 2;
        }

        // Render column selection.
        maxNumberOfColumns = 4;
        var columnSelectionHTML = "Columns: ";
        for (col = 1; col <= maxNumberOfColumns; col++) {
            // Add switch link.
            if (col != numberOfColumns) {
                columnSelectionHTML += "<a href=\"#\" onClick=\"setColumns(" + col + "); event.preventDefault();\">" + col + "</a>";
            } else {
                columnSelectionHTML += col;
            }

            if (col != maxNumberOfColumns) {
                columnSelectionHTML += " | ";
            }
        }
        $("#columnSelection").html(columnSelectionHTML);
        var imageWidthPercentage = (100 / numberOfColumns) - 1;

        // Initial rendering.
        $.ajax({
            url: '../api/v1/status/' + dashboardId,
            success: function (data) {
                appVersion = data.appVersion;
                configLastUpdated = data.configLastUpdated;
                $("#title").text(data.title);

                // Sort images based on order in url hash.
                var imageOrder = getHashParam()["imageOrder"];
                if(imageOrder) {
                    data.images.sort(function (a, b) {
                        return imageOrder.indexOf(a.id) < imageOrder.indexOf(b.id) ? -1 : 1;
                    });
                }

                $("#images").html("<ul>");
                for (var i = 0; i < data.images.length; i++) {
                    image = data.images[i];
                    $("#images").html($("#images").html() +
                            "<li class=\"ui-state-default\" style=\"width: " + imageWidthPercentage + "%\"><a href=\"" + image.url + "\" target=\"_blank\">" +
                            "<img style=\"width: 100%\" id=\"" + image.id + "\" " +
                            "data-lastmodified=\"" + image.lastModified + "\" " +
                            "src=\"" + image.filename + "\"></a></li>");
                }
                $("#images").html($("#images").html() + "</ul>");
                $("#images").sortable({
                    deactivate: function( event, ui ) {
                        setURLHash();
                    }
                });
            }
        });

        // Periodic update.
        setInterval(function () {
            $.ajax({
                url: '../api/v1/status/' + dashboardId,
                success: function (data) {
                    // (New backend version OR config update)
                    // AND last refresh was over 30 seconds ago (to throttle refreshes).
                    if (((appVersion != data.appVersion) ||  (configLastUpdated != data.configLastUpdated))
                            && (new Date().getTime() - lastAppRefresh > 30000)) {
                        // Force reload of page from server to keep front- and backend in sync.
                        refreshPage();
                    }

                    for (var i = 0; i < data.images.length; i++) {
                        image = data.images[i];
                        imageElement = $('img#' + image.id)
                        storedLastModified = imageElement.attr("data-lastmodified");
                        newLastModified = image.lastModified;
                        if (newLastModified != storedLastModified) {
                            // refresh.
                            imageElement.attr('data-lastmodified', image.lastModified);
                            imageElement.attr('src', image.filename + '?' + image.lastModified);
                        }
                        if (newLastModified > lastUpdated) {
                            lastUpdated = newLastModified;
                            $("#lastUpdated").text(new Date(lastUpdated));
                        }
                    }
                }
            });
            // Scan each second for updated images.
        }, 1000);

    });
</script>
<div id="topBar">
    <span id="back">
        <a href=".."><img src="back-icon.png" id="backIcon"></a>
    </span>
        <span id="logo" class="logo-bordered">
            <a href="https://github.com/bertjan/watchboard">
            Watchboard
            </a>
        </span>
    <span id="columnSelection"></span>
    <span>
        <span id="title"></span>
    </span>
    <div id="lastUpdatedWrapper">
        Last updated: <span id="lastUpdated">(never)</span>
    </div>
</div>

<div id="images"></div>

</body>
</html>